andrina.exe 
md5: c58afcc8f44d43451fa17baaac180b18

When andina.exe is executed it creates a hidden folder: C:\nzlsdslkss

- fwurmrbx.exe
- jhbhkhmll.exe
- luamu7ffcgm
- rntmf5qtdul
- tzkqqtwd

It also creates the following registry key "HKCU\Software\Microsoft\Windows\CurrentVersion\Run\SSDP Tools Device Transaction Image" with the value "C:\nzlsdslkss\fwurmrbx.exe". This allows the malware to be executed automatically whenever the current user logs in the machine again.

Two processes are created: fwurmrbx.exe and jhbhkhmll.exe
Both images are actually the same, but they behave differently depending on the supplied commandline. What happens is that the OS creates an instance of fwurmrbx.exe when the user logs in, and then fwurmrbx.exe calls CreateProcessA("C:\\nzlsdslkss\\jhbhkhmll.exe", "emiquiugqhko", ....). The command "emiquiugqhko" dictates that the new process jhbhkhmll.exe has to monitor on the first one and restart it in the case the process gets terminated by any reason. Moreover, if any debugger is attached to fwurmrbx.exe, the second process jhbhkhmll.exe will eventually call TerminateProcess() to kill it as a form of antidebugging technique.


The process then starts an encrypted communication session with different hosts. The connection is TCP based and usually the servers are listening in a high port. An example of such communication can be found in andrina1.pcap.
The strings utility was run on andrina.exe but nothing meaningful was found apart from some Windows API function names. The attached file strings.txt has this output. 

At this point the binary was opened with IDA Pro to understand more about the communication mentioned above.

The binary is obfuscated with a lot of garbage instructions. For instance, all the basic blocks painted with a light orange colour in example_obfuscation.png are not useful at all, they don't do anything but changing values of global variables which are not referenced anywhere else.

Andrina uses a special function to decrypt all the strings that are required for a specific task, and then it zeroes out the memory in order to prevent automated tools from extracting them easily.
This function can be quicly recognized as it is called in several places and it receives two parameters: an offset and a length.
Before this function can be actually called, an structure which I called GlobalData must be decrypted. The Encrypted-GlobalData in the given sample starts at offset 00487000 and has a length of 0x49EC.
This Encrypted-GlobalData has its decryption Key embedded in it at offset 487008 (8 bytes from the structure start). For this particular sample, the decryption key is 0xc940257f. The decryption key is actually a seed that it's feed to a stream-cipher generator. 

DWORD vaporStreamCipher(DWORD key) {
	__asm {
		mov eax, key;
		rol eax, 0x1d;
		mov key, eax;
		push ebx;	
		movzx eax, byte ptr[key + 1];
		movzx ebx, byte ptr[key + 2];
		add al, bl;
		mov byte ptr [key + 2], al;
		movzx eax, byte ptr[key + 1];
		movzx ebx, byte ptr[key + 2];
		add al, bl;
		mov byte ptr[key + 1], al;
		pop ebx;
		mov eax, key;
	}
	return;
}

DWORD* GlobalTableDecryption(void) {

	DWORD Seed = 0xc940257f;
	DWORD tableSize = 0x49EC;
	DWORD *table = (DWORD *)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, tableSize);
	int i = 0;
	DWORD key = Seed;
	for (i = 0; i < tableSize/4; i++) {
		printf("%08x ", key);
		table[i] = key;
		key = vaporStreamCipher(key);		
	}
	return table;
}

The result is a DecryptionTable, which is then used by the DecryptString function. This function takes the offset argument as an index into both, the DecryptionTable and the Encrypted-GlobalData and performs a XOR operation between the corresponding bytes up to the length argument. The result is a plain text string.

For the communication part, we first introduce the next reversed structures:

//Has a size of 0x14
typedef struct _NikeObject { 
    PVOID nike_vtable;
	union {
		PVOID Buffer;
		PVapor vaporObjects;
	}    
	size_t	ContentSize;
	unsigned int ready;
	union {
		size_t BufferSize; // This dictates the actual buffer length of vaporObjects array
		DWORD TypeObject; // -> a value 1 here is for Objects that will hold a plaintext String
	}
} NikeObject;

typedef struct _DoubleNike {
	NikeObject nike1;
	NikeObject nike2;
} DoubleNike;

// Has a size of 0x1C
typedef struct _Vapor { 
    PVOID vapor_vtable;
	PVOID buffer;
    void unknown;  // initialized to 0
	unsigned int ready;
	unsigned int	buffer_size;
	size_t SizeOfOriginalBuffer //the size of the string stored in the original buffer
	DWORD EncryptionKey
} Vapor;


typedef struct _RequestAllocation {
	// This is all like a header
	size_t sizeOfRequestAllocation;
	DWORD unknown // initialized to 0
	size_t sizeOfData // strlen('/index.php?isp2p')
	unsigned char unk; //Initialized to 2
	// At this point the data starts
	char *data[]
}

typedef struct _CipherStream {
	DWORD NumberOfUsableCipherBytes; //Expressed in bytes, not DWORDS
	DWORD EncryptionKey	;		
	CHAR ENCRYPTION_BLOCK[0x1000];	
} CipherStream;

// Has a size of 0x2024
typedef struct _connection_block {
	/*
	//DWORD NumberOfUsableSendKeyBytes; //Expressed in bytes, not DWORDS
	//DWORD SendEncryptionKey	;		
	//CHAR *SEND_ENCRYPTION_BLOCK[0x1000];	
	//+0x100C DWORD NumberOfUsableReceiveKeyBytes;
	//+0x1010 DWORD RecvEncrptionKey; // CalculateRecvDecryptionKey(EncryptionKey1)
	//+0x1014 CHAR *RECV_ENCRYPTION_BLOCK[0x1000];
	*/
	
	CipherStream SendCipherStream;
	CipherStream RecvCipherStream;	
	+0x2018 function generate_encryption_decryption_table_in_connection_buffer_at_offset sub_402260
	+0x201C function CalculateRecvDecryptionKey sub_423090
	+0x2020 socket
} connection_block;

 
- NikeObj is by far the most used object in the binary; most of the time it contains plain data/strings that is going to be used by another function.
- VaporObj is similar to nikeObj but the difference is that contains encrypted data. At its offset 0x18 it has an EncryptionKey which can be used along with the same StreamCipher described before to decrypt the data stored in its buffer.
- RequestAllocation is a temporal object that holds an HTTP Request which is going to be encrypted and sent to some server.
- ConnectionBlock is the structure that maintains the State of the StreamCiphers (DecryptionBytes and EncryptionKeys) for both: data to be sent and data to be received. It also has a function at 0x2018 which is another StreamCipher Generator function (different from the presented above) that generates the decryption bytes for SendCipherStream and RecvCipherStream. It's worth noting that the key of RecvCipherStream is actually generated by the SendCipherStream->SendEncryptionKey through CalculateRecvDecryptionKey() at offset 0x201C. The last member of this structure is the socket that was opened to the server.

The main process of Andrina (fwurmrbx.exe) is the one that performs TCP connection to several servers. During the sniffing session however, no DNS requests are made. This means Andrina has a hardcoded collection of tuples (IP, PORT) and has an algorithm to pick one.
This process has a CommunicationThread which runs in a loop and performs several connection to different servers. Andrina calls DecyptString with offset 0xF06 and length 0x600 to get a table of IP,PORT pairs. Then it initializes an array of indexes and randomize it whith the idea of using these to get a random IP/PORT. 

The next dump shows an array with mixed indexes:

RandomINdexes Example:
0:003> dd 0020bd60 
0020bd60  0000002d 00000034 0000002f 0000000f
0020bd70  00000031 0000002b 00000019 00000006
0020bd80  0000000a 00000012 00000013 00000032
0020bd90  0000003f 00000017 00000035 00000011
0020bda0  00000026 0000002a 0000001e 00000020
0020bdb0  0000002c 00000007 0000003b 00000008
0020bdc0  00000015 0000002e 00000024 00000000
0020bdd0  00000001 00000010 0000000b 00000033
0020bde0  0000003a 00000004 0000001b 00000036
0020bdf0  00000027 00000002 0000001a 0000000d
0020be00  0000001d 0000001f 00000016 00000003
0020be10  00000021 00000037 00000030 00000039
0020be20  00000028 0000000c 00000018 0000003c
0020be30  00000009 00000025 00000029 0000003e
0020be40  00000038 0000003d 0000000e 0000001c
0020be50  00000022 00000005 00000014 00000023

Even though the decypted table had a length of 0x600, the actual usable data is determined by the first byte. 
The table format is: [NumOfObjects, IP, PORT, IP, PORT, ..., IP, PORT]

The full list of IP/PORTS can be extracted with the following python script:

# This was decrypted from the Encrypted-GlobalData
TABLE_IP_PORT = [
0x40,0x67,0x3b,0xcd,0x28,0x59,0xbc,0x25,0x8e,0xf7,0xdf,0x59,0xb9,0x59,0x8a,0xd9,
0x15,0x52,0xdc,0x4f,0xb6,0x50,0xb4,0x83,0x62,0x51,0x86,0x01,0x09,0xb0,0xdf,0xb0,
0x25,0x02,0x2b,0xad,0x0f,0x75,0xda,0xbb,0x1c,0xa4,0x51,0x6c,0xbd,0x8c,0x44,0xa0,
0xf9,0x32,0xfa,0xe7,0xce,0xc6,0x58,0x56,0xb9,0x92,0x7e,0x79,0x06,0x05,0x59,0x8a,
0x25,0x8b,0xf9,0x48,0x84,0x4c,0x08,0x8b,0xc3,0x02,0x32,0x9c,0x4e,0x8b,0x7f,0x57,
0x45,0xee,0xb8,0xae,0xb4,0xbd,0xf4,0x33,0x60,0x6d,0xda,0x59,0x78,0x65,0x40,0x77,
0xfa,0x5d,0xad,0x8c,0xc4,0x74,0xa7,0x3d,0xf6,0x02,0xd9,0x64,0xf0,0x58,0x94,0x24,
0x04,0x64,0x98,0x53,0x6e,0xcb,0x8d,0x68,0x6e,0xd5,0x25,0x05,0x4f,0xc0,0xe4,0x54,
0x5e,0x2d,0x59,0xc2,0x3f,0x2e,0x19,0x86,0x16,0x8c,0xc2,0x56,0x23,0xc5,0xf5,0x65,
0x7a,0xbc,0x02,0x0a,0x06,0xaf,0x2b,0xc8,0x7b,0x98,0x61,0x6c,0x22,0x5e,0xcd,0xa0,
0x35,0x8e,0x03,0x56,0x62,0x45,0x6a,0xa2,0x76,0x5a,0x4b,0xd7,0x8c,0xc0,0x8b,0x46,
0xc4,0x87,0x50,0xa2,0x1c,0x7a,0xa0,0x7b,0xad,0x8f,0xc5,0xbc,0x4e,0x76,0x34,0x5a,
0xcd,0x4e,0x79,0x82,0xbf,0x5c,0x93,0xc5,0x10,0xa0,0xd3,0x86,0xf6,0x57,0x47,0x40,
0x7f,0x75,0x42,0x62,0x46,0xde,0x99,0x51,0xba,0xd9,0xa5,0x04,0x89,0x67,0x86,0x59,
0x2d,0xa3,0x3f,0xc3,0xb0,0xbc,0x56,0x83,0x2d,0x71,0x3e,0x02,0x32,0x8e,0xab,0x57,
0xa5,0x6d,0x66,0x4f,0x1b,0x8d,0xb0,0x5d,0x9c,0x90,0xb1,0x76,0xfb,0x6d,0x63,0x8e,
0x06,0x4e,0xbb,0x6c,0x23,0x96,0xf3,0x60,0xfe,0x4a,0x41,0x40,0x19,0x58,0xd3,0xb0,
0x24,0xb1,0x13,0x64,0x1e,0x5e,0xc9,0x72,0x8a,0xac,0xde,0x59,0x82,0x14,0x0c,0xb6,
0x61,0x57,0x43,0xf5,0x08,0x83,0x5f,0x02,0x32,0xa2,0x0b,0x89,0x7c,0xba,0x78,0x23,
0x89,0xaa,0x65,0x4f,0x76,0x84,0xd5,0x58,0xf5,0x51,0x23,0xde,0x7c,0x7c,0x42,0x02,
0x32,0x89,0x41,0x6b,0xb9,0x54,0x6c,0x80,0x19,0x69,0xfc,0x5e,0x43,0xc8,0x93,0xa3,
0xc5,0x56,0x7f,0x11,0x0f,0xb2,0x78,0xbc,0x19,0x3b,0xe0,0x6b,0x22,0xb9,0x5f,0x49,
0xf6,0x6b,0xb9,0xb2,0xfa,0x8a,0xd0,0x4f,0xc6,0x4b,0x55,0xd3,0xea,0x79,0x58,0x59,
0x89,0xfc,0x1c,0xbd,0xc0,0x55,0x40,0x56,0x29,0xc9,0x19,0x67,0xff,0xe8,0x73,0xa2]

def convert_ip(dword_ip):
    d = dword_ip & 0xFF;
    c = (dword_ip >> 8) & 0xFF;
    b = (dword_ip >> 16) & 0xFF;
    a = (dword_ip >> 24) & 0xFF;

    conv = "{3:d}.{2:d}.{1:d}.{0:d}".format( a, b, c, d)
    return conv


def list_ip_and_ports():
    print "Table Length: %02x" % TABLE_IP_PORT[0]
    i = 0
    try:
        while i < TABLE_IP_PORT[0]:
            index = i * 3
            index = index * 2 + 1
            ip_dword = (TABLE_IP_PORT[index+3]<<24) + (TABLE_IP_PORT[index+2]<<16) + (TABLE_IP_PORT[index+1]<<8) + TABLE_IP_PORT[index]
            port = (TABLE_IP_PORT[index+4]<<8) + TABLE_IP_PORT[index+5]
            print "%s : %d" % (convert_ip(ip_dword), port)
            i += 1
    except:
        pass

Executing this script will throw the next output:

Table Length: 40
103.59.205.40 : 22972
37.142.247.223 : 22969
89.138.217.21 : 21212
79.182.80.180 : 33634
81.134.1.9 : 45279
176.37.2.43 : 44303
117.218.187.28 : 42065
108.189.140.68 : 41209
50.250.231.206 : 50776
86.185.146.126 : 30982
5.89.138.37 : 35833
72.132.76.8 : 35779
2.50.156.78 : 35711
87.69.238.184 : 44724
189.244.51.96 : 28122
89.120.101.64 : 30714
93.173.140.196 : 29863
61.246.2.217 : 25840
88.148.36.4 : 25752
83.110.203.141 : 26734
213.37.5.79 : 49380
84.94.45.89 : 49727
46.25.134.22 : 36034
86.35.197.245 : 25978
188.2.10.6 : 44843
200.123.152.97 : 27682
94.205.160.53 : 36355
86.98.69.106 : 41590
90.75.215.140 : 49291
70.196.135.80 : 41500
122.160.123.173 : 36805
188.78.118.52 : 23245
78.121.130.191 : 23699
197.16.160.211 : 34550
87.71.64.127 : 30018
98.70.222.153 : 20922
217.165.4.137 : 26502
89.45.163.63 : 50096
188.86.131.45 : 28990
2.50.142.171 : 22437
109.102.79.27 : 36272
93.156.144.177 : 30459
109.99.142.6 : 20155
108.35.150.243 : 24830
74.65.64.25 : 22739
176.36.177.19 : 25630
94.201.114.138 : 44254
89.130.20.12 : 46689
87.67.245.8 : 33631
2.50.162.11 : 35196
186.120.35.137 : 43621
79.118.132.213 : 22773
81.35.222.124 : 31810
2.50.137.65 : 27577
84.108.128.25 : 27132
94.67.200.147 : 41925
86.127.17.15 : 45688
188.25.59.224 : 27426
185.95.73.246 : 27577
178.250.138.208 : 20422
75.85.211.234 : 31064
89.137.252.28 : 48576
85.64.86.41 : 51481

These are all the IPs that this particular sample has. I saved that list into a file ip_port.txt and then run the next bash script:

# for line in $(cat ip_port.txt | sed "s/ : /-/"); do ip=$(echo $line | cut -d"-" -f1); port=$(echo $line | cut -d"-" -f2); nc -nvv -w 1 -z $ip $port; done

(UNKNOWN) [103.59.205.40] 22972 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [37.142.247.223] 22969 (?) open
 sent 0, rcvd 0
(UNKNOWN) [89.138.217.21] 21212 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [79.182.80.180] 33634 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [81.134.1.9] 45279 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [176.37.2.43] 44303 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [117.218.187.28] 42065 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [108.189.140.68] 41209 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [50.250.231.206] 50776 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [86.185.146.126] 30982 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [5.89.138.37] 35833 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [72.132.76.8] 35779 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [2.50.156.78] 35711 (?) open
 sent 0, rcvd 0
(UNKNOWN) [87.69.238.184] 44724 (?) open
 sent 0, rcvd 0
(UNKNOWN) [189.244.51.96] 28122 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [89.120.101.64] 30714 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [93.173.140.196] 29863 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [61.246.2.217] 25840 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [88.148.36.4] 25752 (?) open
 sent 0, rcvd 0
(UNKNOWN) [83.110.203.141] 26734 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [213.37.5.79] 49380 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [84.94.45.89] 49727 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [46.25.134.22] 36034 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [86.35.197.245] 25978 (?) open
 sent 0, rcvd 0
(UNKNOWN) [188.2.10.6] 44843 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [200.123.152.97] 27682 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [94.205.160.53] 36355 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [86.98.69.106] 41590 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [90.75.215.140] 49291 (?) open
 sent 0, rcvd 0
(UNKNOWN) [70.196.135.80] 41500 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [122.160.123.173] 36805 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [188.78.118.52] 23245 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [78.121.130.191] 23699 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [197.16.160.211] 34550 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [87.71.64.127] 30018 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [98.70.222.153] 20922 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [217.165.4.137] 26502 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [89.45.163.63] 50096 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [188.86.131.45] 28990 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [2.50.142.171] 22437 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [109.102.79.27] 36272 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [93.156.144.177] 30459 (?) open
 sent 0, rcvd 0
(UNKNOWN) [109.99.142.6] 20155 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [108.35.150.243] 24830 (?) open
 sent 0, rcvd 0
(UNKNOWN) [74.65.64.25] 22739 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [176.36.177.19] 25630 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [94.201.114.138] 44254 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [89.130.20.12] 46689 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [87.67.245.8] 33631 (?) open
 sent 0, rcvd 0
(UNKNOWN) [2.50.162.11] 35196 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [186.120.35.137] 43621 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [79.118.132.213] 22773 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [81.35.222.124] 31810 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [2.50.137.65] 27577 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [84.108.128.25] 27132 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [94.67.200.147] 41925 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [86.127.17.15] 45688 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [188.25.59.224] 27426 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [185.95.73.246] 27577 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [178.250.138.208] 20422 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [75.85.211.234] 31064 (?) open
 sent 0, rcvd 0
(UNKNOWN) [89.137.252.28] 48576 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [85.64.86.41] 51481 (?) : Connection timed out
 sent 0, rcvd 0
 
It can be seen that only 10 hosts were active at the time the sample was dissected.

Once the IP/PORT was chosen, the CommunicationThread opens a TCP connection to it, and starts sending/receiving data. All the data is encrypted with a StreamCipher as was mentioned before, so the first thing that Andrina sends to the server is the EncryptionKey/Seed to the server so it can decrypt the data as well.

Andrina calls CryptAcquireContext and CryptGenRandom to get a random Seed. It actually calls this twice, it gets two random DWORDS, Key1 and Key2, then applies the following algorithm to key1:

def encrypt_key1(key):
	key = ROL(key, 0x1f, 32)
	key[1] = key[0] + key[1]
	key[0] = key[0] + key[1]
	
The result is XORed with Key2, and then it sends both DWORDS [key1, transoformed_key2] to the server. The reason for the transformed_key2 remains unknown given that contrary to key1, it is not stored in the connection_block or anywhere else for future use. 

Also, it feeds key1 to:

def CalculateRecvDecryptionKey(key):
	key = ROL(key,0x06,32)
	key[1] = key[2] + key[1]
	key[2] = key[2] + key[1]

The result is stored at the connection_block struct as RecvEncrptionKey. 

From this point, for any further value that is going to be sent, Andrina uses the CipherStream function stored at connection_block offset 0x2018. 
As an example, let's say we're going to send a single byte to the server: 
 Andrina actually calls a function which I called encrypt_and_send, which before sending the databuffer calls to another function generate_encryption_block_and_xor_buffer. The algorithm to encrypt the data goes something like this:
 
void generate_encryption_block_and_xor_buffer (void *CipherStream, char *ptr_bufferdata, uint bytesToSend) {
	// ECX has the ptr_connection_block_base
	DWORD key;
	uint EncryptionDwordsToGenerate;
	uint remaining_not_encrypted_bytes = bytesToSend;
	while(remaining_not_encrypted_bytes > 0) {
		if (CipherStream->NumberOfUsableCipherBytes != 0) {
			uint blockSize = remaining_not_encrypted_bytes <= 0x1000 ? remaining_not_encrypted_bytes : 0x1000;
			EncryptionDwordsToGenerate = blockSize/4 + 1;
			void *ptr_top_ENCRYPTION_BLOCK = CipherStream->ENCRYPTION_BLOCK + EncryptionDwordsToGenerate * 4;
			ptr_current = CipherStream->ENCRYPTION_BLOCK;
			key = CipherStream->EncryptionKey;
			while (ptr_current < ptr_top_ENCRYPTION_BLOCK) {
				*(DWORD *)ptr_current = key;
				ROL (key, 0x06);
				*(char *)key[1] = ((char *)key[2]) + ((char *)key[1]);
				*(char *)key[2] = ((char *)key[2]) + ((char *)key[1]);			
			}
			
			// Update the seed for the next time
			CipherStream->EncryptionKey = key;
			// Update the number of usable cipher bytes
			CipherStream->NumberOfUsableCipherBytes = EncryptionDwordsToGenerate * 4;
		}
		
		iterations = MIN(remaining_not_encrypted_bytes, CipherStream->NumberOfUsableCipherBytes);
		for (int i=0; i<iterations; i++) {
			ptr_bufferdata[i] = ptr_bufferdata[i] XOR CipherStream->ENCRYPTION_BLOCK[i];
		}
		// Discard used cipher bytes, leaving only those that were not used		
	}	
}

The same algorithm is applied for data that is received, with the difference that CipherStream pointer will have the RecvCipherStream instead of the SendCipherStream.

The first connection to the server goes something like this:

Andrina sends the encryptionKeys (8 bytes).
Andrina sends the value 0x13 //Possibly a length/command
Andrina sends the value 0x0002 // unknown
Andrina sends the amount of bytes that it going to send next, the first time is a struct of 0x13 bytes, so it sends 0x0013
Andrina sends something like this: 13 00 00 00 00 00 00 00-07 00 00 00 03 59 89 fc 1c bd c0
								   [DWORD LENGTH][DWORDMAYBE A COMMAND][REMOTE IP ADDR][PORT]
								   Remote IP Addr and Port are the same of the server that receives the data.
Andrina sends a double null terminator : 0x0000
Andrina receives a DWORD RecvLen from the server that indicates the amount of data to expect.
Andrina receives up to RecvLen bytes from the server.
Finally Andrina sends the amount of bytes received (TOTALBytesReceived) from the server in a DWORD.

-- Of course all the data is encrypted using the previously mentioned StreamCipher algorithm.

This matches a pcap capture:

00000000  5b 8f 75 8b 20 f0 90 bd   -> Encryption Keys
00000008  48 -> 0x13 
		  8d 75 -> 0x0002
		  98 e2 -> How many bytes are going to be sent 
		  2a 9c dd  b7 86 94 67 d9 c9 ef e5 79 aa 2e 81 d4 58 fd 21 ->Arbitrary Data
		  b9 b9  -> Terminator               


    00000000  b0 3f  -> The size of the data to expect from the server
	// Data
    00000002  33 aa d6 d1 94 67 d9 ce  b7 e5 4b 53 7b ad 98 d0 3....g.. ..KS{...
    00000012  e6 8b 39 a0 32 10 31 1d  0a 0f 9d 66 99 1b 17 d9 ..9.2.1. ...f....
    00000022  02 2a 72 02 0a 88 8c 36  01 82 84 2b 8f 74 f0 86 .*r....6 ...+.t..
    00000032  a1 d4 84 cc 3a 54 4b e0  88 59 f7 33 8e ed 56 0a ....:TK. .Y.3..V.
    00000042  fd 78 ef df f3 ca 6f b8  a2 ae 14 bd c8 f2 88 f1 .x....o. ........
    00000052  fe d8 c3 f9 78 fe 92 28  30 8e f3 eb ee fa f6 60 ....x..( 0......`
    00000062  d5 4d 34 2d 9e d3 22 75  bb cc 38 c9 39 7e 61 0a .M4-.."u ..8.9~a.
    00000072  34 1f 60 16 eb 33 1a a3  df 04 74 79 c5 bc 7b e9 4.`..3.. ..ty..{.
    00000082  65 01 e6 cb 25 6e ef 55  5f f6 c0 5d f1 da d7 cb e...%n.U _..]....
    00000092  cc 8b 0f 7c 8a bc 07 92  05 8d 31 18 51 51 dd 46 ...|.... ..1.QQ.F
    000000A2  b2 8e e3 fc 3b 25 31 10  74 1f 3e d6 22 c2 9c 67 ....;%1. t.>."..g
    000000B2  b4 5d 7b a2 69 f0 f7 7e  93 28 07 03 3b e8 79 f5 .]{.i..~ .(..;.y.
    000000C2  88 6f 1a a7 b0 21 f0 e8  b4 74 a8 85 a7 db 31 6b .o...!.. .t....1k
    000000D2  ba ad 85 66 f1 1e e6 94  0a 4e 2d c2 bb dc 31 0a ...f.... .N-...1.
    000000E2  9a 24 c7 a4 0c 3c aa ab  6a 4a 41 be 42 96 fc 82 .$...<.. jJA.B...
    000000F2  7b 4d 7b 5e 00 d6 a9 1b  16 40 aa 7e fd ad ba 2a {M{^.... .@.~...*
    00000102  8c 32 21 1e 86 53 2c 03  30 47 9d d8 67 51 ed cf .2!..S,. 0G..gQ..
    00000112  75 67 0c e8 0a 86 4f 45  bc a4 b9 32 8e d0 32 10 ug....OE ...2..2.
    00000122  a2 81 87 0e 89 9d df 4b  14 6f 71 47 e3 66 bc 61 .......K .oqG.f.a
    00000132  9e 36 b4 3b e7 70 51 57  cf 15 5f 4e ca 74 cb 31 .6.;.pQW .._N.t.1
    00000142  6a 52 ae 69 20 ce 05 3e  8e 48 17 c8 c5 1a 15 a6 jR.i ..> .H......
    00000152  dc 73 99 aa 54 92 99 10  8e de 1e b0 0b da d6 ce .s..T... ........
    00000162  c8 9a d1 80 79 47 be c6  6a 98 73 18 b8 66 9a 7a ....yG.. j.s..f.z
    00000172  83 cb 8a 13 39 4e d3 38  1b 15 16 2f 6a 9d 02 13 ....9N.8 .../j...
    00000182  be 9c ff af 87 29 84 58  79 cc d1 17 d6 62 12 dd .....).X y....b..
    00000192  21 1c fa 1d 6e db 5e f4  fc 32 b3 f3 8a d4 d2 6c !...n.^. .2.....l
    000001A2  e8 d2 ce 2f a0 ea 31 59  5e 53 8a bf cd 41 75 20 .../..1Y ^S...Au 
    000001B2  28 13 d7 4d b7 a7 1b 8b  cb 26 d2 48 70 55 c9 77 (..M.... .&.HpU.w
    000001C2  75 9a ab b9 4b 32 bc b7  c7 1d 0e cd 2c b2 b0 99 u...K2.. ....,...
    000001D2  9c 1b 05 b7 93 12 b9 07  59 0c 46 2f 4b 4b 24 92 ........ Y.F/KK$.
    000001E2  99 7b ca 70 9a ee 2f 0e  64 45 8b 31 ef 06 cf 56 .{.p../. dE.1...V
    000001F2  19 6b a5 9f 2d b9 87 e4  e6 9a e8 f0 0c 90 20 8d .k..-... ...... .
    00000202  52 87 ff 41 25 c2 95 15  4a 8a 2e 8d 9e b0 91 0a R..A%... J.......
    00000212  04 1a 0e 3f de 85 b7 d0  fe e6 fa 56 7a 49 d6 91 ...?.... ...VzI..
    00000222  ea 88 2e b4 4c 05 f5 47  9b 1b 12 b6 a9 79 af 7e ....L..G .....y.~
    00000232  fe fc a3 f4 b1 71 d7 f3  f3 25 1d f1 1f fb fd 8f .....q.. .%......
    00000242  30 3e d5 0a 0f 95 cf 8d  15 45 0f 5a 8d 6a 80 eb 0>...... .E.Z.j..
    00000252  71 92 5a b7 a7 87 5d bf  7e ac c3 7d fb c2 f8 36 q.Z...]. ~..}...6
    00000262  a8 e0 51 f8 be 31 e8 db  0e 09 ac c4 d1 9d ca 87 ..Q..1.. ........
    00000272  a3 b5 66 66 c6 7a 75 b5  56 39 a0 70 8b 6c 07 03 ..ff.zu. V9.p.l..
    00000282  c3 32 13 31 af 4e 40 0a  10 de ef a3 4c ac 12 56 .2.1.N@. ....L..V
    00000292  ae 2a e9 f8 e7 56 78 2c  09 40 40 ce 96 74 c4 aa .*...Vx, .@@..t..
    000002A2  17 b6 31 73 7e bc e2 31  62 2b 8c 67 3a 86 45 86 ..1s~..1 b+.g:.E.
    000002B2  be 91 12 08 97 fb 51 5d  8b aa 5a 33 4b 3a 37 91 ......Q] ..Z3K:7.
    000002C2  eb b0 14 1c f0 a5 1b 03  85 c6 42 bb 71 e7 96 c7 ........ ..B.q...
    000002D2  1b 4b f9 21 49 9f 5c 80  33 62 ef 4b 31 61 f4 c2 .K.!I.\. 3b.K1a..
    000002E2  09 48 af be 05 51 e2 01  d0 11 2c 3a 16 b1 73 6c .H...Q.. ..,:..sl
    000002F2  7e 68 95 45 b9 b8 ad db  63 81 43 7e 3a a5 53 d6 ~h.E.... c.C~:.S.
    00000302  c6 75 26 22 2f 39 04 74  c9 bd 17 df 48 47 62 d8 .u&"/9.t ....HGb.
    00000312  1a 2e 17 e9 a7 60 73 60  d5 50 bf de ac 27 d1 6c .....`s` .P...'.l
    00000322  3e ac 65 e6 79 b4 c4 16  68 c3 df 27 c3 26 f2 93 >.e.y... h..'.&..
    00000332  a6 6d e5 6e 5e fc 15 b6  6b b6 bd 06 79 02 a4 3f .m.n^... k...y..?
    00000342  7a a5 8d 54 b1 13 72 29  38 f7 44 78 7e 65 e4 11 z..T..r) 8.Dx~e..
    00000352  ad 40 a4 65 35 86 65 91  04 0f 77 86 b6 4f d7 02 .@.e5.e. ..w..O..
    00000362  1d ee 3b f2 db c5 ed c5  e9 fb 7c bd 62 8f 1b 85 ..;..... ..|.b...
    00000372  44 cf e6 94 6a 5c 03 a5  b0 89 a1 ab 7f ad b5 42 D...j\.. .......B
    00000382  bd e9 42 8e 6a 32 16 04  28 59 e6 99 18 a9 41 3f ..B.j2.. (Y....A?
    00000392  0d be c8 58 09 6a 76 72  14 a5 1d 9d 04 26 31 8a ...X.jvr .....&1.
    000003A2  7c 52 38 9f e3 90 0d 89  49 f7 a0 0e de 0e ad 62 |R8..... I......b
    000003B2  bc d7 42 e2 6d 0c ce 06  52 09 51 7e 58 79 88 75 ..B.m... R.Q~Xy.u
    000003C2  0d 3d 70 e8 81 60 9c ef  7c c0 c5 f7 e8 3f d0 87 .=p..`.. |....?..
    000003D2  57 ad 6a 71 ca 45 62 10  38 2f 8d 31 51 cb 5c 31 W.jq.Eb. 8/.1Q.\1
    000003E2  24 32 02 49 f4 f6 9d e3  a4 98 ad 4d e7 c4 df ab $2.I.... ...M....
    000003F2  59 45 03 da 7d 0b f4 c7  7d 7d 35 69 f2 76 2b 09 YE..}... }}5i.v+.
    00000402  a1 ea 57 3a 8d 40 ff ee  ae 13 33 b8 48 c3 83 89 ..W:.@.. ..3.H...
    00000412  01 1f 2a b0 a9 cc 60 c2  66 c1 21 bd 1c c1 14 fa ..*...`. f.!.....
    00000422  1f 24 6c ef 2e b7 ae 67  91 dd 9a a2 cc 53 3d 2a .$l....g .....S=*
    00000432  20 75 3c f5 5f 6f f6 da  92 9c 89 12 f1 f7 9b fa  u<._o.. ........
    00000442  f5 2c c8 c3 47 67 4f 28  78 e8 ff ba 72 8c 9f 6e .,..GgO( x...r..n
    00000452  d7 6a c7 6f cf 4e 6f 8a  a5 4a 24 7a a6 0c 62 30 .j.o.No. .J$z..b0
    00000462  30 78 b7 53 44 65 91 c1  51 15 ab 77 01 72 61 7d 0x.SDe.. Q..w.ra}
    00000472  c3 db 66 07 b9 82 74 6f  e2 4b d5 79 70 82 21 04 ..f...to .K.yp.!.
    00000482  bd 51 66 b8 53 35 36 af  8e f9 54 b1 6e 3c 8b 42 .Qf.S56. ..T.n<.B
    00000492  11 74 75 07 88 eb 15 10  e0 13 3b 22 67 b8 cb e2 .tu..... ..;"g...
    000004A2  5e ed 8c 0e 30 17 72 2b  81 51 42 3b 88 b2 dd 2b ^...0.r+ .QB;...+
    000004B2  c0 67 de a1 1f 42 2c a7  99 bf e7 7e 49 1d e8 9d .g...B,. ...~I...
    000004C2  e9 50 46 49 87 33 d0 3c  81 a1 24 1f 23 74 44 15 .PFI.3.< ..$.#tD.
    000004D2  05 e4 12 5e 19 88 d4 22  03 1c 9c e6 d4 b5 e5 fb ...^..." ........
    000004E2  dd 28 04 e4 25 10 a1 82  45 5e 71 98 1c 1f 96 ae .(..%... E^q.....
    000004F2  a4 7f ca 29 89 2e 7b 6a  33 ca 67 6a 5c 8b b9 b4 ...)..{j 3.gj\...
    00000502  ed b4 4a e7 51 57 93 ec  3b e5 3f 01 66 f4 58 8d ..J.QW.. ;.?.f.X.
    00000512  9c 3a 0d 2a bb ef c3 bf  7e 07 0c 0e 32 fc fa c3 .:.*.... ~...2...
    00000522  25 1e 4e 00 66 bf 81 c1  8a 14 93 8e 03 0a 71 e5 %.N.f... ......q.
    00000532  f8 18 83 4c e6 3c d2 94  65 5c 42 38 13 d9 ea 83 ...L.<.. e\B8....
    00000542  36 6f a3 5d 83 f6 a5 4b  38 c0 15 86 19 6b a1 53 6o.]...K 8....k.S
    00000552  b4 f4 cc 10 d2 11 3e 79  05 3b bd b1 56 f0 eb f9 ......>y .;..V...
    00000562  0c cf 72 75 65 23 77 37  7f a6 60 65 74 19 c5 c0 ..rue#w7 ..`et...
    00000572  fb 73 a1 bf b9 86 03 08  f4 03 0d cf 45 38 6c e5 .s...... ....E8l.
    00000582  7b 2a 75 e7 d7 1c fa e1  f6 81 cc 94 48 25 66 97 {*u..... ....H%f.
    00000592  f5 29 d7 15 73 4c b7 11  d1 1c 19 fe bc 40 ee 4f .)..sL.. .....@.O
    000005A2  2f c6 9b c2 70 97 21 2c  0b c2 0f b9 2e d0 0e 84 /...p.!, ........
    000005B2  5b 2b 7f 38 ca 00 72 9c  24 4a ed 5f 99 97 85 b3 [+.8..r. $J._....
    000005C2  8c 39 b8 61 8b 34 69 38  39 7c 53 d6 a2 e8 b9 f3 .9.a.4i8 9|S.....
    000005D2  fd 27 48 2b 22 77 aa 90  c0 c8 9d 0c c7 bc 58 ad .'H+"w.. ......X.
    000005E2  a6 b0 14 20 60 9f 31 52  fd 19 c7 4d 44 0e 31 08 ... `.1R ...MD.1.
    000005F2  21 fc 2b c7 29 1c d1 2e  b1 9f 34 c8 35 32 3d 64 !.+.)... ..4.52=d
    00000602  d6 d6 19 fd 3e 00 fd e6  bc e4 00 48 59 38 7a cf ....>... ...HY8z.
    00000612  ed 10 9b dd f3 62 f1 d3  7c bb c2 75 50 e5 5c b0 .....b.. |..uP.\.
    00000622  22 c6 2b c9 55 52 e6 d1  78 10 0a 80 63 c5 3d 89 ".+.UR.. x...c.=.
    00000632  db 1e d3 e3 85 98 ae 6c  da 36 d7 86 d4 b1 58 94 .......l .6....X.
    00000642  22 24 7f 74 47 25 6a af  32 1e 75 3d e6 3c 10 bb "$.tG%j. 2.u=.<..
    00000652  46 3c                                            F<
    00000654  c2 10                                            ..	
	
00000022  09 ea 7b 5c                                      ..{\ --> TOTALBytesReceived


The received data is different depending on what the client sends, for instance, in the case of the command 0x13 mentioned above, the data is only ciphered with the key that was sent. There are other cases in which the data has double encryption.

In the case of a single encryption (command 0x13) the data presents the following format:

[TimeStampHigh_DW, TimeStampLog_DW, NumOfObjects_W, IP_DW, PORT_W, ..., ]

An example of data is:

006d4f80  76 ff 7c 57 00 00 00 00-58 00 32 fa e7 d6 c6 58  v.|W....X.2....X
006d4f90  54 6c 80 19 69 fc 4a 41-40 19 58 d3 d5 89 73 47  Tl..i.JA@.X...sG
006d4fa0  c9 b9 56 82 6d 7a b0 df-c8 1b a2 e2 cc 06 6c bd  ..V.mz........l.
006d4fb0  8c 44 a0 f9 b9 5f 49 f6-6b b9 4f 76 84 d5 58 f5  .D..._I.k.Ov..X.
006d4fc0  6d 7a 6f dd b2 6e 46 58-82 be 50 ff b2 fa 8a d0  mzo..nFX..P.....
006d4fd0  4f c6 44 71 a8 52 79 6b-55 ba 3e a1 74 e3 b0 25  O.Dq.RykU.>.t..%
006d4fe0  02 2b ad 0f 6d 66 4f 1b-8d b0 67 ff e8 73 a2 ee  .+..mfO...g..s..
006d4ff0  05 6b bd bf c9 3f 59 82-14 0c b6 61 25 8e f7 df  .k...?Y....a%...
006d5000  59 b9 c8 7b 98 61 6c 22-bc 19 3b e0 6b 22 29 e6  Y..{.al"..;.k").
006d5010  10 ad 86 f6 1f 0b 6a 96-63 68 48 84 4c 08 8b c3  ......j.chH.L...
006d5020  5e c9 72 8a ac de 4f 91-2a fa 87 29 bd 95 c9 8a  ^.r...O.*..)....
006d5030  58 ba 02 32 a2 0b 89 7c-75 da bb 1c a4 51 57 43  X..2...|u....QWC
006d5040  f5 08 83 5f d5 fe 87 4c-96 ad 5e 43 c8 93 a3 c5  ..._...L..^C....
006d5050  25 b6 03 e9 8b f9 5f 10-2d 90 5a cd 4b 55 d3 ea  %....._.-.Z.KU..
006d5060  79 58 58 94 24 04 64 98-55 40 c3 01 c9 19 5f 4d  yXX.$.d.U@...._M
006d5070  c5 af 83 c5 4e 79 82 bf-5c 93 5e cd a1 7f 8e 03  ....Ny..\.^.....
006d5080  d9 a5 04 89 67 86 59 2d-a3 3f c3 b0 54 75 64 3e  ....g.Y-.?..Tud>
006d5090  be 6b 4f b6 50 b4 83 62-02 32 9c 4e 8b 7f 59 78  .kO.P..b.2.N..Yx
006d50a0  65 40 77 fa 47 ec c3 b2-a2 1c 6d 42 20 8b 87 69  e@w.G.....mB ..i
006d50b0  57 46 68 6b 75 42 5d 9c-90 b1 76 fb 6d 63 8e 06  WFhkuB]...v.mc..
006d50c0  4e bb d4 b7 cb 87 97 ab-02 32 89 41 6b b9 bd af  N........2.Ak...
006d50d0  77 98 a3 86 ba 78 23 89-aa 65 b0 24 b1 13 64 1e  w....x#..e.$..d.
006d50e0  bd f4 4a 20 6d da 59 88-1c dd a2 54 67 3b cd 7d  ..J m.Y....Tg;.}
006d50f0  59 bc 57 45 ee b8 ae b4-7a a0 7b ad 8f c5 54 e8  Y.WE....z.{...T.
006d5100  e5 a5 71 7c 56 7f 11 0f-b2 78 bc ad 59 50 5e 54  ..q|V....x..YP^T
006d5110  56 bf d2 28 79 06 69 e3-18 77 62 21 5d ad 8c c4  V..(y.i..wb!]...
006d5120  74 a7 53 6e cb 8d 68 6e-59 89 fc 1c bd c0 d5 25  t.Sn..hnY......%
006d5130  05 4f c0 e4 5d ac d9 64-52 dc 6c 23 96 f3 60 fe  .O..]..dR.l#..`.
006d5140  56 23 c5 f5 65 7a 2e 19-86 16 8c c2 56 62 04 fa  V#..ez......Vb..
006d5150  7a 05 02 32 8e ab 57 a5-5a 4b d7 8c c0 8b 54 5e  z..2..W.ZK....T^
006d5160  2d 59 c2 3f 18 43 04 5b-8c 25 53 6e 9b 3c c1 5b  -Y.?.C.[.%Sn.<.[
006d5170  3d f6 02 d9 64 f0 55 1e-ad c8 7c 42 bc 02 04 5c  =...d.U...|B...\
006d5180  af 2b d4 fc 14 fd 5a ac-62 46 dd 2c 51 ba 53 6e  .+....Z.bF.,Q.Sn
006d5190  48 a9 a2 76 bc 56 83 2d-71 3e aa 87 98 f5 d7 38  H..v.V.-q>.....8
006d51a0  fb aa 28 5b 69 b2 16 cd-cf e8 c2 68 c1 b6 fd e2  ..([i......h....
006d51b0  7f 2e 21 9d 5a 61 c9 1f-c4 ed 73 30 04 b6 44 c0  ..!.Za....s0..D.
006d51c0  bf c7 1e a4 e6 0e 0a cc-57 e8 3b 17 52 bd 81 0d  ........W.;.R...
006d51d0  57 9b d6 cd b6 e9 ed 47-5c ad a6 f2 5e 2d 5d e6  W......G\...^-].
006d51e0  a3 19 76 37 f7 6a 78 0a-ed c9 aa 6f 81 c5 8a e1  ..v7.jx....o....
006d51f0  ce 61 ac 1e 80 06 13 c7-eb 0e bc d9 be 65 80 9b  .a...........e..
006d5200  c7 b7 00 00 00 00 1a 1d-53 fa f2 41 18 e7 af b3  ........S..A....
006d5210  b3 e7 52 b7 9c 3f a6 8c-2c 0a 8f 34 72 e8 78 06  ..R..?..,..4r.x.
006d5220  70 65 bb 6f 60 1b 25 ad-c1 cd 00 c6 ff c4 53 5c  pe.o`.%.......S\
006d5230  c7 35 41 a1 6c 88 bf 12-9f d6 4c 6e 10 0c d3 af  .5A.l.....Ln....
006d5240  91 e9 d4 26 34 6a 11 9f-93 e0 78 02 4d e3 05 5b  ...&4j....x.M..[
006d5250  a0 89 e1 5c 7b 53 66 dc-0f df ff 57 64 25 e4 4c  ...\{Sf....Wd%.L
006d5260  61 15 ca 32 04 3d 0f 52-18 c2 1e cc b6 10 90 da  a..2.=.R........
006d5270  40 c0 94 65 e2 6f 30 e1-6a 73 c5 dd 89 b8 a9 fa  @..e.o0.js......
006d5280  5b 73 f6 14 65 27 37 4a-a0 86 74 1a a2 65 7b f8  [s..e'7J..t..e{.
006d5290  42 a7 a5 17 1e 79 35 34-d7 29 09 a7 09 a1 69 8d  B....y54.)....i.
006d52a0  c3 71 c8 fb 5c dc 33 63-0f 22 45 5a 0b 65 91 26  .q..\.3c."EZ.e.&
006d52b0  f1 9d 55 f1 f6 46 bd a9-eb 69 67 87 5c ff 7e 7c  ..U..F...ig.\.~|
006d52c0  ff b4 da 1a 4d 71 76 c8-ee 4f 19 25 1e 22 8d ed  ....Mqv..O.%."..
006d52d0  95 64 62 94 46 c4 5d 9e-75 5b 93 db 9c 09 2d bb  .db.F.].u[....-.
006d52e0  e9 14 b4 84 ee a7 cf 82-cd 54 45 58 8c f9 da 49  .........TEX...I
006d52f0  eb 71 d7 2a d4 d5 16 0e-0c 50 fe 2b 9c af ad de  .q.*.....P.+....
006d5300  92 d4 9e bf 9d 05 22 3f-ba 41 a1 a5 0a 13 cf 06  ......"?.A......
006d5310  03 54 3a fe d2 4d be 16-dd 7c ca 55 3f 44 b8 61  .T:..M...|.U?D.a
006d5320  91 8b bc ed ea 23 44 30-3d b6 f8 f7 3d a1 e5 6b  .....#D0=...=..k
006d5330  a9 98 ee d1 5d e6 af 04-dd 83 79 55 dd 87 88 ae  ....].....yU....
006d5340  e9 ca d8 49 9a 3c 31 e4-b3 2b e2 96 72 72 16 12  ...I.<1..+..rr..
006d5350  3c 63 c4 ab 6a 00 5f da-70 1b 30 91 cd 83 94 b6  <c..j._.p.0.....
006d5360  21 42 f9 99 c3 c8 9d 30-5b 6e a1 95 ee 74 48 39  !B.....0[n...tH9
006d5370  9d 5d f6 8e 36 89 db fe-43 a7 8b 27 32 59 5a 5f  .]..6...C..'2YZ_
006d5380  97 65 3a c6 7e f8 60 c6-46 56 d4 be db 13 f6 eb  .e:.~.`.FV......
006d5390  15 4d 1b ec 28 d0 85 23-73 82 e7 84 90 08 13 7f  .M..(..#s.......
006d53a0  89 27 01 54 8a 0c b3 a0-d7 cc 20 57 7b 1b 75 a0  .'.T...... W{.u.
006d53b0  84 9a e2 3d 16 50 7d 66-a8 16 aa b5 9f ed 29 57  ...=.P}f......)W
006d53c0  28 b5 06 11 fc 94 0b 66-e1 39 f5 e7 0b 38 03 81  (......f.9...8..
006d53d0  29 0a a3 d3 e3 a8 85 0d-07 ad 16 ac f5 0c d3 69  )..............i
006d53e0  31 80 ea 34 de 5d 78 f6-66 5e 97 38 df 5e 71 f5  1..4.]x.f^.8.^q.
006d53f0  70 62 a2 b4 30 e0 cb 67-6d da 6f 18 23 14 9e 69  pb..0..gm.o.#..i
006d5400  84 2b 90 51 7b c2 6e 21-fa e4 64 54 64 79 41 fc  .+.Q{.n!..dTdyA.
006d5410  f3 69 99 2c ee 54 f2 58-3f e7 3e b7 a7 57 70 d3  .i.,.T.X?.>..Wp.
006d5420  88 77 47 4d 41 99 ec 29-0b b4 52 fc 5d 81 48 a5  .wGMA..)..R.].H.
006d5430  7c cd 71 41 8d 34 e7 13-75 14 c5 49 d0 a3 d4 ad  |.qA.4..u..I....
006d5440  ac 48 c9 50 79 fb 87 3f-16 24 c8 0e cf c7 1a 50  .H.Py..?.$.....P
006d5450  fe cc 6f 27 ab 00 41 9f-86 a2 f8 d9 8b 92 e5 93  ..o'..A.........
006d5460  7e fa 09 72 73 2d ff ab-82 94 52 a5 d0 49 d5 69  ~..rs-....R..I.i
006d5470  f4 22 bf ef 4f ed b2 e6-15 11 38 66 8c f0 9b ca  ."..O.....8f....
006d5480  cf 05 6a f1 09 9f a2 18-ce 44 6d 8f 15 67 d9 e7  ..j......Dm..g..
006d5490  fc c9 a1 b7 43 3a 01 72-9a d7 6b e7 a6 19 2d a6  ....C:.r..k...-.
006d54a0  14 61 14 28 79 40 65 4c-ba 8f eb ac 08 c6 42 5c  .a.(y@eL......B\
006d54b0  e4 21 f9 cd 2d 95 45 b6-14 c9 be d1 d3 0e a2 eb  .!..-.E.........
006d54c0  95 8f c5 76 c6 dc 1c 47-0f b1 71 9d 78 ff b5 c4  ...v...G..q.x...
006d54d0  11 61 7e ec b3 96 a6 88-eb f1 c0 5f 8d 3c 9b f0  .a~........_.<..
006d54e0  04 84 26 a5 90 9a 55 d3-40 ae e1 ad dc 15 e2 8b  ..&...U.@.......
006d54f0  5f 71 7c be bd df c0 b4-a1 b6 d2 58 b6 8b 4c a0  _q|........X..L.
006d5500  df 76 32 be 8b 6d 15 41-94 78 b7 dd 0f 2f fa ab  .v2..m.A.x.../..
006d5510  da 5e e7 12 d9 53 b5 31-96 19 4b e9 6a 34 b4 08  .^...S.1..K.j4..
006d5520  e7 1c f5 9a 2d 1a f9 a2-ea 58 4a 24 2e 95 ad cb  ....-....XJ$....
006d5530  0d 59 6c 0f 00 dd 23 8f-33 ed 6e cb 91 0c 12 b9  .Yl...#.3.n.....
006d5540  1c 6f 4b 38 0f af 66 77-fd ae 98 fe 64 c2 bd 9b  .oK8..fw....d...
006d5550  9a 21 f6 6b c8 c8 ab 41-13 ad 78 d9 7b 16 04 8c  .!.k...A..x.{...
006d5560  df 79 5a f9 db ff b7 ff-22 0a 4c bb 6e 87 f0 58  .yZ.....".L.n..X
006d5570  2c b0 d0 69 92 76 29 c5-b0 5d 3e a5 1e f1 38 40  ,..i.v)..]>...8@
006d5580  5f 28 38 a4 de 3b 34 b4-ad 5f 73 24 f2 4b f9 59  _(8..;4.._s$.K.Y
006d5590  af 2b 33 d1 da 51 54 30-71 ef b1 98 f9 4c 66 d1  .+3..QT0q....Lf.
006d55a0  0c ac 6b 11 ba 84 3a b2-21 c9 74 83 87 2e ed 1c  ..k...:.!.t.....
006d55b0  bd 60 f4 00 01 8f c3 4e-59 1c 5b 39 d5 da b9 ce  .`.....NY.[9....
006d55c0  df be 78 e3 11 28 7f 8f-1a 77 03 c5 01 93 a5 87  ..x..(...w......
006d55d0  5e d2 32 60 ba e2 fb 48-f5 7c 56 25 91 73 4b fa  ^.2`...H.|V%.sK.
006d55e0  3a ae cf 4a 5f 0a 8f 4a-29 b0 9c 21 43 43 13 26  :..J_..J)..!CC.&
006d55f0  0f 25 bf 9f 57 e5 28 52-5d 9b de ca 7f bb cd da  .%..W.(R].......
006d5600  77 7c fc 4b 06 88 


Which states in the 3rd DWORD that there are 0x58 IP/PORT pair objects.

Dumping that data we get:

50.250.231.214 : 50776    --  32 fa e7 d6
84.108.128.25 : 27132    --  54 6c 80 19
74.65.64.25 : 22739    --  4a 41 40 19
213.137.115.71 : 51641    --  d5 89 73 47
86.130.109.122 : 45279    --  56 82 6d 7a
200.27.162.226 : 52230    --  c8 1b a2 e2
108.189.140.68 : 41209    --  6c bd 8c 44
185.95.73.246 : 27577    --  b9 5f 49 f6
79.118.132.213 : 22773    --  4f 76 84 d5
109.122.111.221 : 45678    --  6d 7a 6f dd
70.88.130.190 : 20735    --  46 58 82 be
178.250.138.208 : 20422    --  b2 fa 8a d0
68.113.168.82 : 31083    --  44 71 a8 52
85.186.62.161 : 29923    --  55 ba 3e a1
176.37.2.43 : 44303    --  b0 25 02 2b
109.102.79.27 : 36272    --  6d 66 4f 1b
103.255.232.115 : 41710    --  67 ff e8 73
5.107.189.191 : 51519    --  05 6b bd bf
89.130.20.12 : 46689    --  59 82 14 0c
37.142.247.223 : 22969    --  25 8e f7 df
200.123.152.97 : 27682    --  c8 7b 98 61
188.25.59.224 : 27426    --  bc 19 3b e0
41.230.16.173 : 34550    --  29 e6 10 ad
31.11.106.150 : 25448    --  1f 0b 6a 96
72.132.76.8 : 35779    --  48 84 4c 08
94.201.114.138 : 44254    --  5e c9 72 8a
79.145.42.250 : 34601    --  4f 91 2a fa
189.149.201.138 : 22714    --  bd 95 c9 8a
2.50.162.11 : 35196    --  02 32 a2 0b
117.218.187.28 : 42065    --  75 da bb 1c
87.67.245.8 : 33631    --  57 43 f5 08
213.254.135.76 : 38573    --  d5 fe 87 4c
94.67.200.147 : 41925    --  5e 43 c8 93
37.182.3.233 : 35833    --  25 b6 03 e9
95.16.45.144 : 23245    --  5f 10 2d 90
75.85.211.234 : 31064    --  4b 55 d3 ea
88.148.36.4 : 25752    --  58 94 24 04
85.64.195.1 : 51481    --  55 40 c3 01
95.77.197.175 : 33733    --  5f 4d c5 af
78.121.130.191 : 23699    --  4e 79 82 bf
94.205.161.127 : 36355    --  5e cd a1 7f
217.165.4.137 : 26502    --  d9 a5 04 89
89.45.163.63 : 50096    --  59 2d a3 3f
84.117.100.62 : 48747    --  54 75 64 3e
79.182.80.180 : 33634    --  4f b6 50 b4
2.50.156.78 : 35711    --  02 32 9c 4e
89.120.101.64 : 30714    --  59 78 65 40
71.236.195.178 : 41500    --  47 ec c3 b2
109.66.32.139 : 34665    --  6d 42 20 8b
87.70.104.107 : 30018    --  57 46 68 6b
93.156.144.177 : 30459    --  5d 9c 90 b1
109.99.142.6 : 20155    --  6d 63 8e 06
212.183.203.135 : 38827    --  d4 b7 cb 87
2.50.137.65 : 27577    --  02 32 89 41
189.175.119.152 : 41862    --  bd af 77 98
186.120.35.137 : 43621    --  ba 78 23 89
176.36.177.19 : 25630    --  b0 24 b1 13
189.244.74.32 : 28122    --  bd f4 4a 20
89.136.28.221 : 41556    --  59 88 1c dd
103.59.205.125 : 22972    --  67 3b cd 7d
87.69.238.184 : 44724    --  57 45 ee b8
122.160.123.173 : 36805    --  7a a0 7b ad
84.232.229.165 : 29052    --  54 e8 e5 a5
86.127.17.15 : 45688    --  56 7f 11 0f
188.173.89.80 : 24148    --  bc ad 59 50
86.191.210.40 : 30982    --  56 bf d2 28
105.227.24.119 : 25121    --  69 e3 18 77
93.173.140.196 : 29863    --  5d ad 8c c4
83.110.203.141 : 26734    --  53 6e cb 8d
89.137.252.28 : 48576    --  59 89 fc 1c
213.37.5.79 : 49380    --  d5 25 05 4f
93.172.217.100 : 21212    --  5d ac d9 64
108.35.150.243 : 24830    --  6c 23 96 f3
86.35.197.245 : 25978    --  56 23 c5 f5
46.25.134.22 : 36034    --  2e 19 86 16
86.98.4.250 : 31237    --  56 62 04 fa
2.50.142.171 : 22437    --  02 32 8e ab
90.75.215.140 : 49291    --  5a 4b d7 8c
84.94.45.89 : 49727    --  54 5e 2d 59
24.67.4.91 : 35877    --  18 43 04 5b
83.110.155.60 : 49499    --  53 6e 9b 3c
61.246.2.217 : 25840    --  3d f6 02 d9
85.30.173.200 : 31810    --  55 1e ad c8
188.2.4.92 : 44843    --  bc 02 04 5c
212.252.20.253 : 23212    --  d4 fc 14 fd
98.70.221.44 : 20922    --  62 46 dd 2c
83.110.72.169 : 41590    --  53 6e 48 a9
188.86.131.45 : 28990    --  bc 56 83 2d


for line in $(cat ip_port2.txt | sed "s/ : /-/"); do ip=$(echo $line | cut -d"-" -f1); port=$(echo $line | cut -d"-" -f2); nc -nvv -w 1 -z $ip $port; done
(UNKNOWN) [50.250.231.214] 50776 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [84.108.128.25] 27132 (?) open
 sent 0, rcvd 0
(UNKNOWN) [74.65.64.25] 22739 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [213.137.115.71] 51641 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [86.130.109.122] 45279 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [200.27.162.226] 52230 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [108.189.140.68] 41209 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [185.95.73.246] 27577 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [79.118.132.213] 22773 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [109.122.111.221] 45678 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [70.88.130.190] 20735 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [178.250.138.208] 20422 (?) : No route to host
 sent 0, rcvd 0
(UNKNOWN) [68.113.168.82] 31083 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [85.186.62.161] 29923 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [176.37.2.43] 44303 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [109.102.79.27] 36272 (?) open
 sent 0, rcvd 0
(UNKNOWN) [103.255.232.115] 41710 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [5.107.189.191] 51519 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [89.130.20.12] 46689 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [37.142.247.223] 22969 (?) open
 sent 0, rcvd 0
(UNKNOWN) [200.123.152.97] 27682 (?) open
 sent 0, rcvd 0
(UNKNOWN) [188.25.59.224] 27426 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [41.230.16.173] 34550 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [31.11.106.150] 25448 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [72.132.76.8] 35779 (?) open
 sent 0, rcvd 0
(UNKNOWN) [94.201.114.138] 44254 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [79.145.42.250] 34601 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [189.149.201.138] 22714 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [2.50.162.11] 35196 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [117.218.187.28] 42065 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [87.67.245.8] 33631 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [213.254.135.76] 38573 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [94.67.200.147] 41925 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [37.182.3.233] 35833 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [95.16.45.144] 23245 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [75.85.211.234] 31064 (?) open
 sent 0, rcvd 0
(UNKNOWN) [88.148.36.4] 25752 (?) open
 sent 0, rcvd 0
(UNKNOWN) [85.64.195.1] 51481 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [95.77.197.175] 33733 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [78.121.130.191] 23699 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [94.205.161.127] 36355 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [217.165.4.137] 26502 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [89.45.163.63] 50096 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [84.117.100.62] 48747 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [79.182.80.180] 33634 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [2.50.156.78] 35711 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [89.120.101.64] 30714 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [71.236.195.178] 41500 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [109.66.32.139] 34665 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [87.70.104.107] 30018 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [93.156.144.177] 30459 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [109.99.142.6] 20155 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [212.183.203.135] 38827 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [2.50.137.65] 27577 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [189.175.119.152] 41862 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [186.120.35.137] 43621 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [176.36.177.19] 25630 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [189.244.74.32] 28122 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [89.136.28.221] 41556 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [103.59.205.125] 22972 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [87.69.238.184] 44724 (?) open
 sent 0, rcvd 0
(UNKNOWN) [122.160.123.173] 36805 (?) open
 sent 0, rcvd 0
(UNKNOWN) [84.232.229.165] 29052 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [86.127.17.15] 45688 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [188.173.89.80] 24148 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [86.191.210.40] 30982 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [105.227.24.119] 25121 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [93.173.140.196] 29863 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [83.110.203.141] 26734 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [89.137.252.28] 48576 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [213.37.5.79] 49380 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [93.172.217.100] 21212 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [108.35.150.243] 24830 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [86.35.197.245] 25978 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [46.25.134.22] 36034 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [86.98.4.250] 31237 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [2.50.142.171] 22437 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [90.75.215.140] 49291 (?) open
 sent 0, rcvd 0
(UNKNOWN) [84.94.45.89] 49727 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [24.67.4.91] 35877 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [83.110.155.60] 49499 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [61.246.2.217] 25840 (?) open
 sent 0, rcvd 0
(UNKNOWN) [85.30.173.200] 31810 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [188.2.4.92] 44843 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [212.252.20.253] 23212 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [98.70.221.44] 20922 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [83.110.72.169] 41590 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [188.86.131.45] 28990 (?) : Connection refused
 sent 0, rcvd 0



If we replay the command 0x13 against these servers, it might be possible to obtain a new list with more IP addreses of servers.. Eventually mapping the whole C2 servers

----------------------------------------------------
import socket

s = socket.socket()

s.connect(("84.108.128.25", 27132))


data = "\x5b\x8f\x75\x8b\x20\xf0\x90\xbd"
data += "\x48"
data += "\x8d\x75"
data += "\x98\xe2"
data += "\x2a\x9c\xdd\xb7\x86\x94\x67\xd9\xc9\xef\xe5\x79\xaa\x2e\x81\xd4\x58\xfd\x21"
data += "\xb9\xb9"

s.send(data)

print repr(s.recv(0x1000))

s.close()

----------------------------------------------------


The rest of the data format wasn't analyzed yet..



Using the following breakpoints, one is able to see the data before is actually encrypted for sending, and after it was received and decrypted:

ba e 1 441C20 "r @$t0=(poi(esp+4)); r @$t1=(poi(esp+8)); .printf \"About to send bytes: \\n\"; db $t0 L?$t1; g "
ba e 1 00042FEBC "r @$t0=(poi(esp+2064)); r @$t1=(poi($t0+4)); r @$t2=(poi($t0+8)); .printf \"Recv bytes decrypted: \\n\"; db $t1 L?$t2; g "


En example of the data that is sent to the servers is:

00317510  50 4f 53 54 4d 45 53 53-41 47 45 70 6f 73 74 3d  POSTMESSAGEpost=
00317520  61 32 64 68 63 6d 31 68-62 6d 52 41 5a 6d 39 79  a2dhcm1hbmRAZm9y
00317530  5a 43 35 6a 62 32 30 4a-62 6e 70 73 63 32 52 7a  ZC5jb20Jbnpsc2Rz
00317540  62 47 74 7a 63 77 6c 6d-64 33 56 79 62 58 4a 69  bGtzcwlmd3VybXJi
00317550  65 43 35 6c 65 47 55 4a-61 6d 68 69 61 47 74 6f  eC5leGUJamhiaGto
00317560  62 57 78 73 4c 6d 56 34-5a 51 6c 54 55 30 52 51  bWxsLmV4ZQlTU0RQ
00317570  49 46 52 76 62 32 78 7a-49 45 52 6c 64 6d 6c 6a  IFRvb2xzIERldmlj
00317580  5a 53 42 55 63 6d 46 75-63 32 46 6a 64 47 6c 76  ZSBUcmFuc2FjdGlv
0:001> db
00317590  62 69 42 4a 62 57 46 6e-5a 51 6c 54 54 6b 31 51  biBJbWFnZQlTTk1Q
003175a0  49 46 42 4f 55 6c 41 67-55 33 52 76 63 6d 46 6e  IFBOUlAgU3RvcmFn
003175b0  5a 53 42 46 64 6d 56 75-64 43 42 55 59 58 4e 72  ZSBFdmVudCBUYXNr
003175c0  49 46 4a 6c 63 32 39 31-63 6d 4e 6c 43 54 41 79  IFJlc291cmNlCTAy
003175d0  4d 51 6c 58 53 55 34 74-52 55 78 4e 56 6b 4e 51  MQlXSU4tRUxNVkNQ
003175e0  4e 45 39 46 52 6b 67 4a-4d 44 41 77 51 7a 49 35  NE9FRkgJMDAwQzI5
003175f0  4d 45 45 79 4d 7a 4e 44-43 57 4a 69 59 32 55 32  MEEyMzNDCWJiY2U2
00317600  4e 47 51 33 5a 54 52 6c-4e 54 51 33 59 54 41 33  NGQ3ZTRlNTQ3YTA3
0:001> db
00317610  4d 44 46 6b 59 7a 4e 6d-5a 44 63 32 4d 6d 52 68  MDFkYzNmZDc2MmRh
00317620  4e 44 55 32 43 54 41 31-4d 44 67 75 62 32 5a 6c  NDU2CTA1MDgub2Zl
00317630  63 6e 52 68 00 32 48 00-39 c1 d6 b8 78 47 00 00  cnRh

Decoding that BASE64 we get:

-----------------------------
kgarmand@ford.com	nzlsdslkss	fwurmrbx.exe	jhbhkhmll.exe	SSDP Tools Device Transaction Image	SNMP PNRP Storage Event Task Resource	021	WIN-ELMVCP4OEFH	000C290A233C	bbce64d7e4e547a0701dc3fd762da456	0508.oferta
-----------------------------

Where:
- kgarmand@ford.com is the target malware victim (this is stored encrypted in the GlobalData)
- nzlsdslkss is the name of the malware folder which is hidden in c:\ (the name is hardcoded in the GlobalData)
- fwurmrbx.exe is the name of the main process (the name is hardcoded in the GlobalData)
- jhbhkhmll.exe is the name of the secondary process (the name is hardcoded in the GlobalData) 
- SSDP Tools Device Transaction Image	SNMP PNRP Storage Event Task Resource are the names of the service for persisting upon reboots.
- WIN-ELMVCP4OEFH the machine name
- 000C290A233C unknown
- bbce64d7e4e547a0701dc3fd762da456 unknown md5
- 0508.oferta might be the campaign ?


The received data on the other hand, has a binary form even after decrypted. 



DGA and HTTP Requests:

From the extracted data, we can also get the following list of domain names:

classwritten.net riskukuruzabio.ru blackratoon.cn osmanskayaagressiya.ru morningnature.net shenzhenmicroindustry.cn trademodern.net volshebstvosrednevekoviya.ru morningbicycle.net turetskiyaproblema.ru crazybots.org turkishproblem.ru funlazysocks.com netwonder.net thinkkitchen.net historycover.net japanesefactory.ru booksecure.ru yaponskiizavod.ru captainspecial.net ottomanagression.ru classforever.net tcourier.ru middleshout.net historyshore.net theadulthub.ru biocornrice.ru

Each of these domains are put into a VaporObj and encrypted, then the pointer to the list of VaporObjects is stored in a global NikeObject at 0495794

Later, the CommunicationThread will start exactly 40 threads that will get the global NikeObject and go through the list of VaporObj decrypting the domain name. After that, they  will try to resolve those names,, but none of these succeeds.. They do not resolve to anything...  This might be for deceiving purposses.

On the other hand, after those names fail, the threads will start generating domain names with a custom algorihtm. If any of the resulting domain name is a valid one (gethostbyname() returns an actual hostent structure) then an HTTP transaction will happen.

The next structure is central to understand how the DGA works:

typedef struct _ThreadContext {
	RTL_CRITICAL_SECTION //size 0x14
	+0x18 DWORD Counter // Initialized to 0 / This is guarded by the CritialSection
	+0x1C DWORD UNK2 // Initialized to 0
	+0X20 GetSystemTimeAsFile>>9; //SEED for the DGA
	+0X24 GetSystemTimeAsFile>>9 + 0x200;
	+0x28 DWORD UNK3 // Initialized to 0
	+0x2C void *globalBinaryData; // BinaryData_Global DecryptString(0x4912, 0x908)
	+0x30 void *ptr_names; // All the names that are going to be used in the DGA DecryptString(0x17F3, 0xAF1)
	+0x34 WORD **indexes_into_names; // these are used to index ptr_names / BinaryData_Global DecryptString(0x2020, 0x31E)
	+0x38 char string[0x14]; //Iinitialized to '.ru'
	+0x4C char string[0x14]; //Iinitialized to '.net'	
	+0x60 char string[0x20]; //Initialized to '/index.php
	+0x80 NikeObject nike_Result_Of_SuperSendRecv;
} ThreadContext;


Essentially, ThreadContext is a shared data structure among all the threads that spawns connections to the resolved domains. The important fields for the DGA are:

+0x20 SEED -> this is the seed that gets initialized by the result of a call to GetSystemTimeAsFile()
+0x30 ptr_names 
+0x34 indexes_into_names
+0x38 string '.ru'
+0x4C string '.net'

1. The SEED is used along with indexes_into_names for filling a bytearray of values. The bytearray will have a size of 0xF. 
2. The bytearray is splitted in two halves of 8 elements each.
3. 2 values (one per half) are calculated in the following manner:
	a. value starts with 0.
	b. for element in bytearray_half:
	       value = value * 2
		   value = value | element
4. Now the algorithm is going to pick two random words from the list of ptr_names
5. Both values are going to serve as indexes into indexes_into_names to get the real indexes.
6. The resuling indexes are used to get the two words, which are concatenated.
7. Finally, depending on a flag that the DGA function receives, it appends '.ru' (offset 0x38) or '.net' (offset 0x4C)

		   
+] ptr_names points to the following list of words:

journey destroy against night within effort street better husband little doubt decide suffer through trade gather ridden chair large record forget would flier quiet belong those captain electric increase remember bread season degree answer think chief order leader rather strange forward glass present college require heaven morning history difficult pleasant often middle heavy various amount thick heard necessary alone twelve gentle return weather class movement building fresh gentleman fellow broken summer thought outside evening experience already double result crowd water store doctor follow begin prepare strength woman party might pretty member known desire still smoke fight expect person severa simple figure picture winter finish because machine laugh mother though cigarette subject leave sudden whether mountain perhaps children either sweet several foreign right possible window family english probably material shore welcome dollar proud should industry opinion contain character nature board enough supply settle office device beyond silver forever valley matter school together question flower bring special demand father hunger built storm written around realize complete short became promise basket ladder needle enter govern distance language arrive before being sister bottom labor spent while control therefore minute listen corner shout apple training carry thrown length laughter indeed consider almost attempt orderly neighbor clear smell include safety chance market twenty beauty clean ready course people understand succeed behind produce stream nation bottle please dried round angry likely notice fancy during friend reason square value spread general early north future meeting report understood garden paint brown women daughter broad between butter student nothing soldier divide condition fifteen glossary article worth except further bicycle become strong found president success wagon until kitchen shoulder continue airplane wonder guard advance station goodbye object measure choose afraid period escape space problem yellow wheat single always difference bridge cover whose company trouble spring caught banker without above probable finger master straight discover fence stranger third fortieth childhood dinner although circle however animal travel modern close anger charge forest every branch separate receive clothes borrow toward electricity million honor catch system public number heart strike mayor manner century business power mister method service direct instead surprise bright letter nearly speak shake write believe health quarter distant train pleasure delight white neither eearly trust dress position perfect partial battle another famous appear country suppose action river brought explain beside inside different happen niece share oclock



By Setting the following breakpoints, one is able to recover not only valid domain names but also part sequences of HTTP Request/Response:

// GetHostByName
ba e 1 041B93D  "r @$t0=(poi(esp+4)); .printf \"TARGET DOMAIN: \"; da $t0; "

DGA SEND (HTTP Request)
ba e 1 041BDFC "r @$t0=esi; .printf \"Sending bytes: \\n\"; db eax L?$t0; g "

DGA RECV (HTTP Response)
ba e 1 41BEE5 "r @$t0=eax; .printf \"Recv bytes: \\n\"; db esi L?$t0; g "

+] List of recovered domains:
chiefborrow.net
aloneborrow.net
alonepartial.net  
amountelectricity.net  
amountgarden.net  
amounttoward.net  
betterbutter.net  
breadbehind.net  
breadbutter.net  
chiefattempt.net  
chiefbeauty.net  
chiefgarden.net  
classbeauty.net  
classmarket.net  
classnumber.net  
classreport.net  
collegebattle.net  
collegemarket.net  
collegereport.net  
collegesquare.net  
collegestrike.net  
decidedried.net  
historyattempt.net  
historyheart.net  
middlebeauty.net  
middlemarket.net  
middlemeeting.net  
middlewhite.net  
morningmarket.net  
morningpartial.net  
morningtrain.net  
presentgarden.net  
presentmarket.ru  
presentperfect.net  
presentperfect.ru  
ratherelectricity.net  
rathertoward.net  
strangebeauty.net  
strangeheart.net  
thickspread.net  
thinkbeauty.net  
thinkelectricity.net  
thinkheart.net  
thinkmarket.net  
thinkmayor.net  
thinkpleasure.net  
thinkreport.net  
thinktrain.net  
twelvenumber.net  
twelvesquare.net  
twelveunderstood.net  
weatherheart.net  
weathermayor.net  
weatherpartial.net  
weatherreport.net  
weatherstrike.net  
weathertrain.net 

+] NSlookup

Name:    chiefborrow.net
Addresses:  195.22.28.196
          195.22.28.198
          195.22.28.197
          195.22.28.199
		  
		 
Name:    aloneborrow.net
Addresses:  195.22.28.197
          195.22.28.196
          195.22.28.198
          195.22.28.199		  

Name:    thinktrain.net
Address:  184.168.221.18
 

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 # for line in $(cat ip_temp.txt | sed "s/ : /-/"); do ip=$(echo $line | cut -d"-" -f1); port=$(echo $line | cut -d"-" -f2); nc -nvv -w 1 -z $ip $port; done
(UNKNOWN) [103.255.232.115] 41710 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [103.59.205.125] 22972 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [105.227.24.119] 25121 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [108.189.140.68] 41209 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [108.35.150.243] 24830 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [109.102.79.27] 36272 (?) open
 sent 0, rcvd 0
(UNKNOWN) [109.122.111.221] 45678 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [109.66.32.139] 34665 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [109.99.142.6] 20155 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [117.218.187.28] 42065 (?) open
 sent 0, rcvd 0
(UNKNOWN) [122.160.123.173] 36805 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [176.36.177.19] 25630 (?) open
 sent 0, rcvd 0
(UNKNOWN) [176.37.2.43] 44303 (?) open
 sent 0, rcvd 0
(UNKNOWN) [178.250.138.208] 20422 (?) : No route to host
 sent 0, rcvd 0
(UNKNOWN) [185.95.73.246] 27577 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [186.120.35.137] 43621 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [188.173.89.80] 24148 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [188.2.4.92] 44843 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [188.25.59.224] 27426 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [188.86.131.45] 28990 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [189.149.201.138] 22714 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [189.175.119.152] 41862 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [189.244.74.32] 28122 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [200.123.152.97] 27682 (?) open
 sent 0, rcvd 0
(UNKNOWN) [200.27.162.226] 52230 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [212.183.203.135] 38827 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [212.252.20.253] 23212 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [213.137.115.71] 51641 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [213.254.135.76] 38573 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [213.37.5.79] 49380 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [217.165.4.137] 26502 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [24.67.4.91] 35877 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [2.50.137.65] 27577 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [2.50.142.171] 22437 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [2.50.156.78] 35711 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [2.50.162.11] 35196 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [31.11.106.150] 25448 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [37.142.247.223] 22969 (?) open
 sent 0, rcvd 0
(UNKNOWN) [37.182.3.233] 35833 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [41.230.16.173] 34550 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [46.25.134.22] 36034 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [50.250.231.214] 50776 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [5.107.189.191] 51519 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [61.246.2.217] 25840 (?) open
 sent 0, rcvd 0
(UNKNOWN) [68.113.168.82] 31083 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [70.88.130.190] 20735 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [71.236.195.178] 41500 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [72.132.76.8] 35779 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [74.65.64.25] 22739 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [75.85.211.234] 31064 (?) open
 sent 0, rcvd 0
(UNKNOWN) [78.121.130.191] 23699 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [79.118.132.213] 22773 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [79.145.42.250] 34601 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [79.182.80.180] 33634 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [83.110.155.60] 49499 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [83.110.203.141] 26734 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [83.110.72.169] 41590 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [84.108.128.25] 27132 (?) open
 sent 0, rcvd 0
(UNKNOWN) [84.117.100.62] 48747 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [84.232.229.165] 29052 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [84.94.45.89] 49727 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [85.186.62.161] 29923 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [85.30.173.200] 31810 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [85.64.195.1] 51481 (?) open
 sent 0, rcvd 0
(UNKNOWN) [86.127.17.15] 45688 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [86.130.109.122] 45279 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [86.191.210.40] 30982 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [86.35.197.245] 25978 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [86.98.4.250] 31237 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [87.67.245.8] 33631 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [87.69.238.184] 44724 (?) open
 sent 0, rcvd 0
(UNKNOWN) [87.70.104.107] 30018 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [88.148.36.4] 25752 (?) open
 sent 0, rcvd 0
(UNKNOWN) [89.120.101.64] 30714 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [89.130.20.12] 46689 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [89.136.28.221] 41556 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [89.137.252.28] 48576 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [89.45.163.63] 50096 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [90.75.215.140] 49291 (?) open
 sent 0, rcvd 0
(UNKNOWN) [93.156.144.177] 30459 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [93.172.217.100] 21212 (?) : Connection refused
 sent 0, rcvd 0
(UNKNOWN) [93.173.140.196] 29863 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [94.201.114.138] 44254 (?) open
 sent 0, rcvd 0
(UNKNOWN) [94.205.161.127] 36355 (?) open
 sent 0, rcvd 0
(UNKNOWN) [94.67.200.147] 41925 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [95.16.45.144] 23245 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [95.77.197.175] 33733 (?) : Connection timed out
 sent 0, rcvd 0
(UNKNOWN) [98.70.221.44] 20922 (?) : Connection timed out
 sent 0, rcvd 0




